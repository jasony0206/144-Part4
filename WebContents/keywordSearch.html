<!DOCTYPE html>
<html>
<head>
<title>Keyword Search</title>
	
</head>

<body>
<form action="search">
  Query: <input type="text" id="query" name="q">
  <input type="hidden" name="numResultsToSkip" value="0">
  <input type="hidden" name="numResultsToReturn" value="30">
</form>
<div id="suggestion"></div>

<script type="text/javascript">
    window.onload = function () {
    	var oTextbox = new AutoSuggestControl(document.getElementById("query"), new SuggestionProvider());
    }

	var xmlHttp = new XMLHttpRequest();
	
	AutoSuggestControl.prototype.selectRange = function (start, length) {
		if (this.textbox.createTextRange) {
	        var oRange = this.textbox.createTextRange();
	        oRange.moveStart("character", start);
	        oRange.moveEnd("character", length - this.textbox.value.length);
	        oRange.select();
	    } else if (this.textbox.setSelectionRange) {
	        this.textbox.setSelectionRange(start, length);
	    }

	    this.textbox.focus();
	};

	AutoSuggestControl.prototype.typeAhead = function (suggestion) {
		if (this.textbox.createTextRange || this.textbox.setSelectionRange) {
	        var textboxLength = this.textbox.value.length;
	        this.textbox.value = suggestion;
	        this.selectRange(textboxLength, suggestion.length);
    	}
	};

	AutoSuggestControl.prototype.autosuggest = function (suggestion) {
	 	this.typeAhead(suggestion);
	};

	AutoSuggestControl.prototype.handleKeyUp = function (event) {
		var iKeyCode = event.keyCode;

	    if (iKeyCode < 32 || (iKeyCode >= 33 && iKeyCode <= 46) || (iKeyCode >= 112 && iKeyCode <= 123)) {
	        //ignore
	    } else {
	    	this.provider.requestSuggestions(this);
	    }
	};

	AutoSuggestControl.prototype.init = function () {
		var oThis = this;
	    this.textbox.onkeyup = function (oEvent) {
	        if (!oEvent) {
	            oEvent = window.event;
	        }
	        oThis.handleKeyUp(oEvent);
	    };
	};

	function AutoSuggestControl(textbox, provider) {
		this.provider = provider;
		this.textbox = textbox;
		this.init();
	}

	SuggestionProvider.prototype.requestSuggestions = function (autoSuggestControlObj) {
		console.log(autoSuggestControlObj.textbox.value);
		var request = "suggest?q=" + encodeURI(autoSuggestControlObj.textbox.value);

		xmlHttp.open("GET", request);
		xmlHttp.onreadystatechange = function () {
			if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
				var xmlDoc = xmlHttp.responseXML;
				if (xmlDoc != undefined) {
					var suggests = xmlDoc.getElementsByTagName("suggestion");
					var firstSuggestion = suggests[0].attributes[0].nodeValue;
					console.log(firstSuggestion);
					if (firstSuggestion.length > autoSuggestControlObj.textbox.value.length) {
						autoSuggestControlObj.autosuggest(firstSuggestion);
					}
				} else {
					//document.getElementById("suggestion").innerHTML = "";
				}
			}
		};
		xmlHttp.send(null); 
	};

	function SuggestionProvider() {
		
	}
</script>
</body>
</html>