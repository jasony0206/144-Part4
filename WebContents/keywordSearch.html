<!DOCTYPE html>
<html>
<head>
<title>Keyword Search</title>
	
</head>

<body>
<form action="search">
  Query: <input type="text" id="query" name="q">
  <input type="hidden" name="numResultsToSkip" value="0">
  <input type="hidden" name="numResultsToReturn" value="30">
</form>
<div id="suggestion"></div>

<script type="text/javascript">
    window.onload = function () {
    	var oTextbox = new AutoSuggestControl(document.getElementById("query"), new SuggestionProvider());
    }

	var xmlHttp = new XMLHttpRequest();
	/*
	function sendQueryToServlet(query, autoSuggestControlObj) {
		var request = "suggest?q=" + encodeURI(query);

		xmlHttp.open("GET", request);
		xmlHttp.onreadystatechange = showSuggestion(autoSuggestControlObj);
		xmlHttp.send(null);
	}
	
	function showSuggestion() {
		if (xmlHttp.readyState == 4) {
			var xmlDoc = xmlHttp.responseXML;
			if (xmlDoc != undefined) {
				var suggestions = xmlDoc.getElementsByTagName("suggestion");
				var limit = Math.min(suggestions.length, 5);
				document.getElementById("suggestion").innerHTML = "";
				for (i = 0; i < limit; i++) {
					document.getElementById("suggestion").innerHTML += suggestions[i].attributes[0].nodeValue + "<br>";
				}
			} else {
				document.getElementById("suggestion").innerHTML = "";
			}
		}
	}
	
	function showSuggestion(autoSuggestControlObj) {
		var suggestions = new Array();
		console.log(xmlHttp.readyState);
		if (xmlHttp.readyState == 4) {
			var xmlDoc = xmlHttp.responseXML;
			if (xmlDoc != undefined) {
				var suggests = xmlDoc.getElementsByTagName("suggestion");
				for (i = 0; i < suggests.length; i++) {
					suggestions[i] = suggests[i].attributes[0].nodeValue;
				}
				autoSuggestControlObj.autosuggest(suggestions);
			} else {
				//document.getElementById("suggestion").innerHTML = "";
			}
		} else {
			console.log("error");
		}
	}
	*/
	AutoSuggestControl.prototype.selectRange = function (start, length) {
		if (this.textbox.createTextRange) {
        var oRange = this.textbox.createTextRange();
        oRange.moveStart("character", start);
        oRange.moveEnd("character", length - this.textbox.value.length);
        oRange.select();
	    } else if (this.textbox.setSelectionRange) {
	        this.textbox.setSelectionRange(start, length);
	    }

	    this.textbox.focus();
	};

	AutoSuggestControl.prototype.typeAhead = function (suggestion) {
		if (this.textbox.createTextRange || this.textbox.setSelectionRange) {
	        var textboxLength = this.textbox.value.length;
	        this.textbox.value = suggestion;
	        this.selectRange(textboxLength, suggestion.length);
    	}
	};

	AutoSuggestControl.prototype.autosuggest = function (suggestions) {
		if (suggestions.length > 0) {
	        this.typeAhead(suggestions[0]);
	    }
	};

	AutoSuggestControl.prototype.handleKeyUp = function (event) {
		var iKeyCode = event.keyCode;

	    if (iKeyCode < 32 || (iKeyCode >= 33 && iKeyCode <= 46) || (iKeyCode >= 112 && iKeyCode <= 123)) {
	        //ignore
	    } else {
	    	this.provider.requestSuggestions(this);
	    }
	};

	AutoSuggestControl.prototype.init = function () {
		var oThis = this;
	    this.textbox.onkeyup = function (oEvent) {
	        if (!oEvent) {
	            oEvent = window.event;
	        }
	        oThis.handleKeyUp(oEvent);
	    };
	};

	function AutoSuggestControl(textbox, provider) {
		this.provider = provider;
		this.textbox = textbox;
		this.init();
	}

	SuggestionProvider.prototype.requestSuggestions = function (autoSuggestControlObj) {
		var request = "suggest?q=" + encodeURI(autoSuggestControlObj.textbox.value);

		xmlHttp.open("GET", request);
		xmlHttp.onreadystatechange = function () {
			var suggestions = new Array();
			if (xmlHttp.readyState == 4) {
				var xmlDoc = xmlHttp.responseXML;
				if (xmlDoc != undefined) {
					var suggests = xmlDoc.getElementsByTagName("suggestion");
					for (i = 0; i < suggests.length; i++) {
						suggestions[i] = suggests[i].attributes[0].nodeValue;
					}
					autoSuggestControlObj.autosuggest(suggestions);
				} else {
					//document.getElementById("suggestion").innerHTML = "";
				}
			}
		};
		xmlHttp.send(null); 
	};

	function SuggestionProvider() {
		
	}
</script>
</body>
</html>